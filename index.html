<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>诱导公式大擂台</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            position: relative;
        }
        
        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .game-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .record {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
        }
        
        .record-title {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .info-item {
            text-align: center;
            flex: 1;
        }
        
        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .progress-bar {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s;
        }
        
        .game-area {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            position: relative;
        }
        
        .formula-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .formula {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #333;
            padding: 12px 18px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            margin-right: 10px;
        }
        
        .result-feedback {
            font-size: 1.8rem;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .correct-answer {
            font-size: 1.2rem;
            color: #ffcc00;
            margin-top: 10px;
            text-align: center;
            min-height: 20px;
        }
        
        .bags-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .bag {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 14px 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            touch-action: manipulation;
            cursor: pointer;
            position: relative;
        }
        
        .bag:active {
            background-color: rgba(255, 255, 255, 0.4);
            transform: scale(0.98);
        }
        
        .score-change {
            position: absolute;
            font-size: 1.2rem;
            font-weight: bold;
            animation: floatUp 1s forwards;
            z-index: 30;
            pointer-events: none;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-40px);
            }
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: #333;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            touch-action: manipulation;
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .instructions {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            overflow-y: auto;
            max-height: 120px;
        }
        
        .instructions h3 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .instructions ul {
            padding-left: 15px;
        }
        
        .instructions li {
            margin-bottom: 3px;
        }
        
        .timer {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffcc00;
        }
        
        .copyright {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .game-over, .success-message, .level-up, .record-form, .rank-popup, .share-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 15px;
        }
        
        .message-box {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            width: 100%;
            max-width: 300px;
        }
        
        .message-box h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        
        .message-box p {
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            text-align: center;
        }
        
        .popup-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .popup-btn {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            border: none;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            color: #333;
            font-weight: bold;
            transition: transform 0.3s, box-shadow 0.3s;
            touch-action: manipulation;
        }
        
        .popup-btn:active {
            transform: scale(0.98);
        }
        
        .rank-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 8px;
        }
        
        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            margin-bottom: 6px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .rank-item.top {
            background-color: rgba(255, 215, 0, 0.3);
        }
        
        .rank-number {
            width: 25px;
            text-align: center;
            font-weight: bold;
        }
        
        .share-options {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        .share-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .share-btn:active {
            transform: scale(0.95);
        }
        
        .wechat {
            background-color: #07c160;
        }
        
        .qq {
            background-color: #12b7f5;
        }
        
        .weibo {
            background-color: #e6162d;
        }
        
        .link {
            background-color: #ffcc00;
        }
        
        @media (max-width: 360px) {
            .bags-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .game-area {
                padding: 10px;
            }
            
            .formula {
                font-size: 1.2rem;
                padding: 10px 14px;
            }
            
            .bag {
                font-size: 1rem;
                padding: 12px 8px;
                min-height: 65px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .instructions {
                max-height: 100px;
            }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                max-width: 100%;
                padding: 5px;
            }
            
            .header {
                margin-bottom: 5px;
            }
            
            .game-info {
                margin-bottom: 5px;
                padding: 5px;
            }
            
            .progress-bar {
                margin-bottom: 5px;
            }
            
            .game-area {
                margin-bottom: 5px;
                padding: 10px;
            }
            
            .bags-container {
                margin-bottom: 5px;
            }
            
            .action-buttons {
                margin-bottom: 5px;
            }
            
            .instructions {
                max-height: 80px;
                padding: 5px;
                font-size: 0.7rem;
            }
            
            .copyright {
                margin-top: 5px;
                padding-top: 5px;
            }
        }
        
        .formula, .bag, button {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="game-title">诱导公式大擂台</div>
            <div class="record">
                <div class="record-title">最快纪录</div>
                <div id="recordTime">时间: /</div>
                <div id="recordName">挑战者: /</div>
            </div>
        </div>
        
        <div class="game-info">
            <div class="info-item">
                <div>分数</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-item">
                <div>等级</div>
                <div class="info-value" id="level">初级</div>
            </div>
            <div class="info-item">
                <div>时间</div>
                <div class="info-value timer" id="timer">02:00</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="game-area" id="gameArea">
            <div class="formula-container">
                <div class="formula" id="currentFormula">sin(π+α) = ?</div>
                <div class="result-feedback" id="resultFeedback"></div>
            </div>
            <div class="correct-answer" id="correctAnswer"></div>
        </div>
        
        <div class="bags-container" id="bagsContainer">
            <div class="bag" onclick="selectAnswer('sin')">sinα</div>
            <div class="bag" onclick="selectAnswer('-sin')">-sinα</div>
            <div class="bag" onclick="selectAnswer('cos')">cosα</div>
            <div class="bag" onclick="selectAnswer('-cos')">-cosα</div>
            <div class="bag" onclick="selectAnswer('tan')">tanα</div>
            <div class="bag" onclick="selectAnswer('-tan')">-tanα</div>
        </div>
        
        <div class="action-buttons">
            <button class="action-btn" onclick="resetToPrimary()">重置游戏</button>
            <button class="action-btn" onclick="showRankPopup()">排行榜</button>
            <button class="action-btn" onclick="showSharePopup()">分享游戏</button>
        </div>
        
        <div class="instructions">
            <h3>游戏说明：</h3>
            <ul>
                <li>点击选择上方公式对应的正确答案</li>
                <li>正确答案 +1 分，错误答案 -1 分</li>
                <li>分数低于 0 分游戏结束</li>
                <li>每个等级需要在规定时间内达到15分才能升级</li>
                <li>初级和中级的挑战时间为2分钟，高级为1分30秒</li>
                <li>高级达到 15 分即可获胜！</li>
                <li>打破最快纪录可以留下您的名字！</li>
                <li>中级失败后回到中级，高级失败后回到高级</li>
                <li>点击"重置游戏"可回到初级</li>
            </ul>
        </div>
        
        <div class="copyright">
            <p>游戏制作者：@尤晴曦</p>
            <p>版权所有 违者必究</p>
        </div>
    </div>
    
    <!-- 弹窗区域 -->
    <div class="game-over hidden" id="gameOverPopup">
        <div class="message-box">
            <h2>游戏结束</h2>
            <p id="gameOverMessage">您的分数低于 0 分，请再接再厉！</p>
            <div class="popup-buttons">
                <button class="popup-btn" onclick="restartGame()">重新开始</button>
            </div>
        </div>
    </div>
    
    <div class="level-up hidden" id="levelUpPopup">
        <div class="message-box">
            <h2 id="levelUpTitle">升级成功！</h2>
            <p id="levelUpMessage">恭喜您成功升级到中级！</p>
            <div class="popup-buttons">
                <button class="popup-btn" onclick="nextLevel()">继续挑战</button>
            </div>
        </div>
    </div>
    
    <div class="record-form hidden" id="recordForm">
        <div class="message-box">
            <h2>恭喜打破纪录！</h2>
            <p id="recordMessage">您以 <span id="recordTimeValue"></span> 的成绩打破了最快纪录！</p>
            <input type="text" id="playerName" placeholder="请输入您的名字" maxlength="10">
            <div class="popup-buttons">
                <button class="popup-btn" onclick="saveRecord()">保存纪录</button>
            </div>
        </div>
    </div>
    
    <div class="success-message hidden" id="successPopup">
        <div class="message-box">
            <h2>恭喜！</h2>
            <p>您已成为诱导公式达人！</p>
            <div class="popup-buttons">
                <button class="popup-btn" onclick="restartGame()">再玩一次</button>
                <button class="popup-btn" onclick="addToRankList()">上榜炫耀</button>
            </div>
        </div>
    </div>
    
    <div class="rank-popup hidden" id="rankPopup">
        <div class="message-box">
            <h2>排行榜</h2>
            <p>诱导公式大擂台 - 最强王者</p>
            <div class="rank-list" id="rankList">
                <!-- 排行榜内容将通过JavaScript动态生成 -->
            </div>
            <div class="popup-buttons">
                <button class="popup-btn" onclick="closePopup('rankPopup')">关闭</button>
            </div>
        </div>
    </div>
    
    <div class="share-popup hidden" id="sharePopup">
        <div class="message-box">
            <h2>分享游戏</h2>
            <p>分享给好友一起挑战吧！</p>
            <div class="share-options">
                <div class="share-btn wechat" title="分享到微信" onclick="shareToWechat()">微</div>
                <div class="share-btn qq" title="分享到QQ" onclick="shareToQQ()">Q</div>
                <div class="share-btn weibo" title="分享到微博" onclick="shareToWeibo()">微</div>
                <div class="share-btn link" title="复制链接" onclick="copyGameLink()">链</div>
            </div>
            <div class="popup-buttons">
                <button class="popup-btn" onclick="closePopup('sharePopup')">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        var gameState = {
            score: 0,
            level: 1,
            timeLeft: 120,
            timerInterval: null,
            isGameActive: true,
            currentFormula: null,
            isWaitingForAnswer: false,
            lastFormula: null, // 记录上一个公式，避免重复
            // 每个级别有独立的记录
            records: {
                level1: { time: null, name: null },
                level2: { time: null, name: null },
                level3: { time: null, name: null }
            },
            rankList: []
        };

        // 诱导公式库
        var formulaLibrary = {
            level1: [
                { formula: "sin(π+α)", answer: "-sin" },
                { formula: "cos(π+α)", answer: "-cos" },
                { formula: "tan(π+α)", answer: "tan" },
                { formula: "sin(π-α)", answer: "sin" },
                { formula: "cos(π-α)", answer: "-cos" },
                { formula: "tan(π-α)", answer: "-tan" },
                { formula: "sin(-α)", answer: "-sin" },
                { formula: "cos(-α)", answer: "cos" },
                { formula: "tan(-α)", answer: "-tan" },
                { formula: "sin(2π-α)", answer: "-sin" },
                { formula: "cos(2π-α)", answer: "cos" },
                { formula: "tan(2π-α)", answer: "-tan" },
                { formula: "sin(π/2+α)", answer: "cos" },
                { formula: "cos(π/2+α)", answer: "-sin" },
                { formula: "sin(π/2-α)", answer: "cos" },
                { formula: "cos(π/2-α)", answer: "sin" },
                { formula: "sin(3π/2+α)", answer: "-cos" },
                { formula: "cos(3π/2+α)", answer: "sin" },
                { formula: "sin(3π/2-α)", answer: "-cos" },
                { formula: "cos(3π/2-α)", answer: "-sin" }
            ],
            level2: [
                { formula: "sin(5π/2+α)", answer: "cos" },
                { formula: "cos(5π/2+α)", answer: "-sin" },
                { formula: "sin(5π/2-α)", answer: "cos" },
                { formula: "cos(5π/2-α)", answer: "sin" },
                { formula: "sin(7π/2+α)", answer: "-cos" },
                { formula: "cos(7π/2+α)", answer: "sin" },
                { formula: "sin(7π/2-α)", answer: "-cos" },
                { formula: "cos(7π/2-α)", answer: "-sin" },
                { formula: "sin(9π/2+α)", answer: "cos" },
                { formula: "cos(9π/2+α)", answer: "-sin" },
                { formula: "sin(9π/2-α)", answer: "cos" },
                { formula: "cos(9π/2-α)", answer: "sin" },
                // 新增中级题库公式
                { formula: "sin(-π/2+α)", answer: "-cos" },
                { formula: "cos(-π/2+α)", answer: "sin" },
                { formula: "sin(-π/2-α)", answer: "-cos" },
                { formula: "cos(-π/2-α)", answer: "-sin" },
                { formula: "sin(-3π/2+α)", answer: "cos" },
                { formula: "cos(-3π/2+α)", answer: "-sin" },
                { formula: "sin(-3π/2-α)", answer: "cos" },
                { formula: "cos(-3π/2-α)", answer: "sin" },
                { formula: "sin(-π+α)", answer: "-sin" },
                { formula: "cos(-π+α)", answer: "-cos" },
                { formula: "tan(-π+α)", answer: "tan" },
                { formula: "sin(-π-α)", answer: "sin" },
                { formula: "cos(-π-α)", answer: "-cos" },
                { formula: "tan(-π-α)", answer: "-tan" },
                { formula: "sin(-2π+α)", answer: "sin" },
                { formula: "cos(-2π+α)", answer: "cos" },
                { formula: "tan(-2π+α)", answer: "tan" },
                { formula: "sin(-2π-α)", answer: "-sin" },
                { formula: "cos(-2π-α)", answer: "cos" },
                { formula: "tan(-2π-α)", answer: "-tan" }
            ],
            level3: [
                // 高级题库与中级题库相同，但时间更短
                { formula: "sin(5π/2+α)", answer: "cos" },
                { formula: "cos(5π/2+α)", answer: "-sin" },
                { formula: "sin(5π/2-α)", answer: "cos" },
                { formula: "cos(5π/2-α)", answer: "sin" },
                { formula: "sin(7π/2+α)", answer: "-cos" },
                { formula: "cos(7π/2+α)", answer: "sin" },
                { formula: "sin(7π/2-α)", answer: "-cos" },
                { formula: "cos(7π/2-α)", answer: "-sin" },
                { formula: "sin(9π/2+α)", answer: "cos" },
                { formula: "cos(9π/2+α)", answer: "-sin" },
                { formula: "sin(9π/2-α)", answer: "cos" },
                { formula: "cos(9π/2-α)", answer: "sin" },
                // 新增中级题库公式
                { formula: "sin(-π/2+α)", answer: "-cos" },
                { formula: "cos(-π/2+α)", answer: "sin" },
                { formula: "sin(-π/2-α)", answer: "-cos" },
                { formula: "cos(-π/2-α)", answer: "-sin" },
                { formula: "sin(-3π/2+α)", answer: "cos" },
                { formula: "cos(-3π/2+α)", answer: "-sin" },
                { formula: "sin(-3π/2-α)", answer: "cos" },
                { formula: "cos(-3π/2-α)", answer: "sin" },
                { formula: "sin(-π+α)", answer: "-sin" },
                { formula: "cos(-π+α)", answer: "-cos" },
                { formula: "tan(-π+α)", answer: "tan" },
                { formula: "sin(-π-α)", answer: "sin" },
                { formula: "cos(-π-α)", answer: "-cos" },
                { formula: "tan(-π-α)", answer: "-tan" },
                { formula: "sin(-2π+α)", answer: "sin" },
                { formula: "cos(-2π+α)", answer: "cos" },
                { formula: "tan(-2π+α)", answer: "tan" },
                { formula: "sin(-2π-α)", answer: "-sin" },
                { formula: "cos(-2π-α)", answer: "cos" },
                { formula: "tan(-2π-α)", answer: "-tan" }
            ]
        };

        // 初始化游戏
        function initGame() {
            // 从localStorage读取当前等级，如果没有则默认为1（初级）
            var savedLevel = localStorage.getItem('inductionFormulaLevel');
            if (savedLevel) {
                gameState.level = parseInt(savedLevel);
            } else {
                gameState.level = 1;
            }
            
            gameState.score = 0;
            
            // 根据等级设置时间
            if (gameState.level === 3) {
                gameState.timeLeft = 90; // 高级为90秒
            } else {
                gameState.timeLeft = 120; // 初级和中级为120秒
            }
            
            gameState.isGameActive = true;
            gameState.currentFormula = null;
            gameState.isWaitingForAnswer = false;
            gameState.lastFormula = null; // 重置上一个公式
            
            // 清除之前的计时器
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            // 加载记录和排行榜
            loadRecords();
            loadRankList();
            
            updateUI();
            startTimer();
            generateNextFormula();
            
            // 隐藏所有弹窗
            var popups = document.querySelectorAll('.game-over, .success-message, .level-up, .record-form, .rank-popup, .share-popup');
            for (var i = 0; i < popups.length; i++) {
                popups[i].classList.add('hidden');
            }
            
            // 重置反馈
            document.getElementById('resultFeedback').textContent = '';
            document.getElementById('correctAnswer').textContent = '';
        }

        // 加载记录
        function loadRecords() {
            try {
                var savedRecords = localStorage.getItem('inductionGameRecords');
                if (savedRecords) {
                    gameState.records = JSON.parse(savedRecords);
                } else {
                    // 如果没有记录，初始化默认记录
                    gameState.records = {
                        level1: { time: null, name: null },
                        level2: { time: null, name: null },
                        level3: { time: null, name: null }
                    };
                }
            } catch (e) {
                console.error('加载记录失败:', e);
                // 如果加载失败，初始化默认记录
                gameState.records = {
                    level1: { time: null, name: null },
                    level2: { time: null, name: null },
                    level3: { time: null, name: null }
                };
            }
            updateRecordDisplay();
        }

        // 保存记录
        function saveRecords() {
            try {
                localStorage.setItem('inductionGameRecords', JSON.stringify(gameState.records));
                console.log('记录保存成功');
            } catch (e) {
                console.error('保存记录失败:', e);
                alert('保存记录失败，请检查浏览器设置');
            }
            updateRecordDisplay();
        }

        // 加载排行榜
        function loadRankList() {
            try {
                var savedRankList = localStorage.getItem('inductionGameRankList');
                if (savedRankList) {
                    gameState.rankList = JSON.parse(savedRankList);
                } else {
                    gameState.rankList = [];
                }
            } catch (e) {
                console.error('加载排行榜失败:', e);
                gameState.rankList = [];
            }
        }

        // 保存排行榜
        function saveRankList() {
            try {
                localStorage.setItem('inductionGameRankList', JSON.stringify(gameState.rankList));
                console.log('排行榜保存成功');
            } catch (e) {
                console.error('保存排行榜失败:', e);
                alert('保存排行榜失败，请检查浏览器设置');
            }
        }

        // 更新记录显示 - 根据当前级别显示对应的记录
        function updateRecordDisplay() {
            var currentLevelRecord = gameState.records['level' + gameState.level];
            if (currentLevelRecord && currentLevelRecord.time) {
                var minutes = Math.floor(currentLevelRecord.time / 60);
                var seconds = currentLevelRecord.time % 60;
                document.getElementById('recordTime').textContent = '时间: ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                document.getElementById('recordName').textContent = '挑战者: ' + currentLevelRecord.name;
            } else {
                document.getElementById('recordTime').textContent = '时间: /';
                document.getElementById('recordName').textContent = '挑战者: /';
            }
        }

        // 检查是否打破纪录 - 只检查当前级别的记录
        function checkRecord() {
            var currentLevel = 'level' + gameState.level;
            var currentRecord = gameState.records[currentLevel];
            var timeUsed;
            
            if (gameState.level === 3) {
                timeUsed = 90 - gameState.timeLeft; // 高级总时间为90秒
            } else {
                timeUsed = 120 - gameState.timeLeft; // 初级和中级总时间为120秒
            }
            
            if (!currentRecord.time || timeUsed < currentRecord.time) {
                return timeUsed;
            }
            return null;
        }

        // 更新UI
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            
            var levelText = "";
            switch(gameState.level) {
                case 1: levelText = "初级"; break;
                case 2: levelText = "中级"; break;
                case 3: levelText = "高级"; break;
            }
            document.getElementById('level').textContent = levelText;
            
            var progress = (gameState.score / 15) * 100;
            document.getElementById('progress').style.width = Math.min(progress, 100) + '%';
            
            updateTimerDisplay();
            updateRecordDisplay();
        }

        // 开始计时器
        function startTimer() {
            gameState.timerInterval = setInterval(function() {
                if (!gameState.isGameActive) {
                    return;
                }
                
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    endGame(false, "时间到了！");
                }
            }, 1000);
        }

        // 更新计时器显示
        function updateTimerDisplay() {
            var minutes = Math.floor(gameState.timeLeft / 60);
            var seconds = gameState.timeLeft % 60;
            document.getElementById('timer').textContent = 
                (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            
            if (gameState.timeLeft <= 30) {
                document.getElementById('timer').style.color = '#ff5252';
            } else {
                document.getElementById('timer').style.color = '#ffcc00';
            }
        }

        // 生成下一个公式 - 避免与上一个公式相同
        function generateNextFormula() {
            if (gameState.isWaitingForAnswer) return;
            
            var formulaPool = [];
            if (gameState.level === 1) {
                formulaPool = formulaLibrary.level1;
            } else if (gameState.level === 2) {
                formulaPool = formulaLibrary.level2;
            } else {
                formulaPool = formulaLibrary.level3;
            }
            
            // 避免连续出现相同的公式
            var selectedFormula;
            var attempts = 0;
            var maxAttempts = 10; // 最多尝试10次，避免无限循环
            
            do {
                var randomIndex = Math.floor(Math.random() * formulaPool.length);
                selectedFormula = formulaPool[randomIndex];
                attempts++;
            } while (selectedFormula.formula === gameState.lastFormula && attempts < maxAttempts);
            
            document.getElementById('currentFormula').textContent = selectedFormula.formula + ' = ?';
            
            gameState.currentFormula = selectedFormula;
            gameState.lastFormula = selectedFormula.formula; // 记录当前公式
            gameState.isWaitingForAnswer = true;
            
            document.getElementById('resultFeedback').textContent = '';
            document.getElementById('correctAnswer').textContent = '';
        }

        // 选择答案
        function selectAnswer(bagAnswer) {
            if (!gameState.isWaitingForAnswer || !gameState.isGameActive) return;
            
            var formulaAnswer = gameState.currentFormula.answer;
            
            if (bagAnswer === formulaAnswer) {
                document.getElementById('resultFeedback').textContent = '✔';
                document.getElementById('resultFeedback').style.color = '#4CAF50';
                updateScore(1);
                showScoreChange('+1', event.target, true);
            } else {
                document.getElementById('resultFeedback').textContent = '✖';
                document.getElementById('resultFeedback').style.color = '#F44336';
                
                var correctAnswerText = '';
                switch(formulaAnswer) {
                    case 'sin': correctAnswerText = 'sinα'; break;
                    case '-sin': correctAnswerText = '-sinα'; break;
                    case 'cos': correctAnswerText = 'cosα'; break;
                    case '-cos': correctAnswerText = '-cosα'; break;
                    case 'tan': correctAnswerText = 'tanα'; break;
                    case '-tan': correctAnswerText = '-tanα'; break;
                }
                document.getElementById('correctAnswer').textContent = '正确答案为: ' + correctAnswerText;
                
                updateScore(-1);
                showScoreChange('-1', event.target, false);
            }
            
            gameState.isWaitingForAnswer = false;
            
            setTimeout(function() {
                if (gameState.isGameActive) {
                    generateNextFormula();
                }
            }, 1500);
        }

        // 更新分数
        function updateScore(change) {
            gameState.score += change;
            updateUI();
            
            if (gameState.score < 0) {
                endGame(false, "您的分数低于 0 分，请再接再厉！");
                return;
            }
            
            if (gameState.score >= 15) {
                if (gameState.level < 3) {
                    var recordTime = checkRecord();
                    if (recordTime !== null) {
                        showRecordForm(recordTime);
                    } else {
                        showLevelUp();
                    }
                } else {
                    var recordTime = checkRecord();
                    if (recordTime !== null) {
                        showRecordForm(recordTime, true);
                    } else {
                        endGame(true);
                    }
                }
            }
        }

        // 显示记录表单
        function showRecordForm(recordTime, isFinalLevel) {
            gameState.isGameActive = false;
            
            var minutes = Math.floor(recordTime / 60);
            var seconds = recordTime % 60;
            document.getElementById('recordTimeValue').textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
            
            if (isFinalLevel) {
                document.getElementById('recordMessage').textContent = '恭喜您以 ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds + ' 的成绩通关并打破纪录！';
            } else {
                document.getElementById('recordMessage').textContent = '您以 ' + minutes + ':' + (seconds < 10 ? '0' : '') + seconds + ' 的成绩打破了最快纪录！';
            }
            
            document.getElementById('playerName').value = '';
            document.getElementById('recordForm').classList.remove('hidden');
        }

        // 保存记录 - 只保存当前级别的记录
        function saveRecord() {
            var playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('请输入您的名字！');
                return;
            }
            
            var currentLevel = 'level' + gameState.level;
            var recordTime;
            
            if (gameState.level === 3) {
                recordTime = 90 - gameState.timeLeft; // 高级总时间为90秒
            } else {
                recordTime = 120 - gameState.timeLeft; // 初级和中级总时间为120秒
            }
            
            gameState.records[currentLevel] = {
                time: recordTime,
                name: playerName
            };
            
            saveRecords();
            document.getElementById('recordForm').classList.add('hidden');
            
            if (gameState.level < 3) {
                showLevelUp();
            } else {
                endGame(true);
            }
        }

        // 显示升级界面
        function showLevelUp() {
            gameState.isGameActive = false;
            
            var nextLevel = gameState.level + 1;
            var levelText = "";
            switch(nextLevel) {
                case 2: levelText = "中级"; break;
                case 3: levelText = "高级"; break;
            }
            
            document.getElementById('levelUpTitle').textContent = '升级成功！';
            document.getElementById('levelUpMessage').textContent = '恭喜您成功升级到' + levelText + '！';
            document.getElementById('levelUpPopup').classList.remove('hidden');
        }

        // 进入下一等级
        function nextLevel() {
            gameState.level++;
            // 保存当前等级到localStorage
            localStorage.setItem('inductionFormulaLevel', gameState.level.toString());
            
            gameState.score = 0;
            
            // 根据等级设置时间
            if (gameState.level === 3) {
                gameState.timeLeft = 90; // 高级为90秒
            } else {
                gameState.timeLeft = 120; // 初级和中级为120秒
            }
            
            gameState.isGameActive = true;
            gameState.currentFormula = null;
            
            updateUI();
            generateNextFormula();
            document.getElementById('levelUpPopup').classList.add('hidden');
        }

        // 结束游戏
        function endGame(isSuccess, message) {
            gameState.isGameActive = false;
            
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            if (isSuccess) {
                document.getElementById('successPopup').classList.remove('hidden');
            } else {
                // 失败时不重置等级，保持当前等级
                document.getElementById('gameOverMessage').textContent = message;
                document.getElementById('gameOverPopup').classList.remove('hidden');
            }
        }

        // 显示分数变化
        function showScoreChange(text, element, isPositive) {
            var scoreChange = document.createElement('div');
            scoreChange.className = 'score-change';
            scoreChange.textContent = text;
            scoreChange.style.color = isPositive ? '#4CAF50' : '#F44336';
            
            var rect = element.getBoundingClientRect();
            
            scoreChange.style.left = (rect.left + rect.width/2 - 20) + 'px';
            scoreChange.style.top = (rect.top - 20) + 'px';
            
            document.body.appendChild(scoreChange);
            
            setTimeout(function() {
                scoreChange.remove();
            }, 1000);
        }

        // 显示排行榜
        function showRankPopup() {
            var rankListElement = document.getElementById('rankList');
            rankListElement.innerHTML = '';
            
            if (gameState.rankList.length === 0) {
                rankListElement.innerHTML = '<p style="text-align: center; padding: 20px;">暂无排行榜数据</p>';
            } else {
                var sortedRankList = gameState.rankList.slice().sort(function(a, b) {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return a.timeUsed - b.timeUsed;
                });
                
                sortedRankList.forEach(function(player, index) {
                    var rankItem = document.createElement('div');
                    rankItem.className = 'rank-item' + (index < 3 ? ' top' : '');
                    
                    var rankNumber = document.createElement('div');
                    rankNumber.className = 'rank-number';
                    rankNumber.textContent = index + 1;
                    
                    var playerInfo = document.createElement('div');
                    playerInfo.className = 'player-info';
                    playerInfo.textContent = player.name + ' - ' + player.score + '分 - ' + formatTime(player.timeUsed);
                    
                    rankItem.appendChild(rankNumber);
                    rankItem.appendChild(playerInfo);
                    rankListElement.appendChild(rankItem);
                });
            }
            
            document.getElementById('rankPopup').classList.remove('hidden');
        }

        // 添加到排行榜
        function addToRankList() {
            var timeUsed;
            
            if (gameState.level === 3) {
                timeUsed = 90 - gameState.timeLeft; // 高级总时间为90秒
            } else {
                timeUsed = 120 - gameState.timeLeft; // 初级和中级总时间为120秒
            }
            
            var playerName = prompt('请输入您的名字（最多10个字符）：', '匿名玩家');
            
            if (playerName !== null) {
                var playerInfo = {
                    name: playerName.substring(0, 10),
                    score: gameState.score,
                    timeUsed: timeUsed,
                    level: gameState.level,
                    date: new Date().toLocaleDateString()
                };
                
                gameState.rankList.push(playerInfo);
                saveRankList();
                
                alert('已成功添加到排行榜！');
                document.getElementById('successPopup').classList.add('hidden');
                
                showRankPopup();
            }
        }

        // 格式化时间
        function formatTime(seconds) {
            var minutes = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return minutes + ':' + (secs < 10 ? '0' : '') + secs;
        }

        // 显示分享弹窗
        function showSharePopup() {
            document.getElementById('sharePopup').classList.remove('hidden');
        }

        // 重置游戏到初级
        function resetToPrimary() {
            // 设置等级为初级
            gameState.level = 1;
            // 保存当前等级到localStorage
            localStorage.setItem('inductionFormulaLevel', gameState.level.toString());
            
            // 重置游戏
            restartGame();
        }

        // 关闭弹窗
        function closePopup(popupId) {
            document.getElementById(popupId).classList.add('hidden');
        }

        // 分享到微信
        function shareToWechat() {
            alert('微信分享功能');
        }

        // 分享到QQ
        function shareToQQ() {
            alert('QQ分享功能');
        }

        // 分享到微博
        function shareToWeibo() {
            alert('微博分享功能');
        }

        // 复制链接
        function copyGameLink() {
            var gameUrl = window.location.href;
            var tempTextArea = document.createElement('textarea');
            tempTextArea.value = gameUrl;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            alert('游戏链接已复制到剪贴板！');
        }

        // 重新开始游戏
        function restartGame() {
            document.getElementById('gameOverPopup').classList.add('hidden');
            document.getElementById('successPopup').classList.add('hidden');
            
            // 重置分数和时间，但不重置等级
            gameState.score = 0;
            
            // 根据等级设置时间
            if (gameState.level === 3) {
                gameState.timeLeft = 90; // 高级为90秒
            } else {
                gameState.timeLeft = 120; // 初级和中级为120秒
            }
            
            gameState.isGameActive = true;
            gameState.currentFormula = null;
            gameState.isWaitingForAnswer = false;
            gameState.lastFormula = null; // 重置上一个公式
            
            // 清除之前的计时器
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            updateUI();
            startTimer();
            generateNextFormula();
            
            // 重置反馈
            document.getElementById('resultFeedback').textContent = '';
            document.getElementById('correctAnswer').textContent = '';
        }

        // 初始化游戏
        window.onload = initGame;
    </script>
</body>
</html>